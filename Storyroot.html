<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Storyroot - Your Story Vault</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üå≥</text></svg>">
    <link rel="stylesheet" href="Storyroot.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
    
    <!-- CodeMirror 5 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/monokai.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/material.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/markdown/markdown.min.js"></script>
</head>
<body>
    <!-- Toast Notification -->
    <div id="toast"></div>

    <!-- Main Layout -->
    <div class="app-container">
        <!-- Left Sidebar - File Explorer -->
        <aside class="sidebar left-sidebar" id="leftSidebar">
            <div class="sidebar-header">
                <h2>üå≥ Storyroot</h2>
                <button class="icon-btn" onclick="toggleLeftSidebar()" title="Toggle Sidebar">‚óÄ</button>
            </div>

            <div class="sidebar-actions">
                <button class="action-btn" onclick="createNewNote()" title="New Note">
                    <span class="btn-icon">üìù</span>
                    <span class="btn-label">New Note</span>
                </button>
                <button class="action-btn" onclick="createNewFolder()" title="New Folder">
                    <span class="btn-icon">üìÅ</span>
                    <span class="btn-label">New Folder</span>
                </button>
            </div>

            <!-- Search Box -->
            <div class="search-container">
                <input type="text" id="searchInput" placeholder="üîç Search notes..." oninput="searchNotes()">
            </div>

            <!-- File Explorer -->
            <div class="file-explorer" id="fileExplorer">
                <!-- Populated by JavaScript -->
            </div>

            <!-- Sidebar Footer -->
            <div class="sidebar-footer">
                <button onclick="openSettingsModal()">‚öôÔ∏è Settings</button>
                <button onclick="exportVault()">üíæ Export</button>
            </div>
        </aside>

        <!-- Main Editor Area -->
        <main class="main-content">
            <!-- Note Tabs -->
            <div class="note-tabs-bar" id="noteTabsBar">
                <!-- Tabs will be dynamically inserted here -->
            </div>
            
            <!-- Top Bar -->
            <div class="editor-header">
                <button class="icon-btn" onclick="toggleLeftSidebar()" id="menuToggle">‚ò∞</button>
                <div class="breadcrumb" id="breadcrumb">
                    <span class="breadcrumb-item">No note selected</span>
                </div>
                <div class="editor-actions">
                    <button class="icon-btn" onclick="toggleRightSidebar()" title="Toggle Backlinks">
                        ‚ñ∂
                    </button>
                </div>
            </div>

            <!-- Editor Container -->
            <div class="editor-container" id="editorContainer">
                <!-- Formatting Toolbar -->
                <div class="formatting-toolbar" id="formattingToolbar">
                    <button class="toolbar-btn" onclick="insertFormatting('bold')" title="Bold (Ctrl+B)">
                        <strong>B</strong>
                    </button>
                    <button class="toolbar-btn" onclick="insertFormatting('italic')" title="Italic (Ctrl+I)">
                        <em>I</em>
                    </button>
                    <button class="toolbar-btn" onclick="insertFormatting('strikethrough')" title="Strikethrough">
                        <s>S</s>
                    </button>
                    <div class="toolbar-separator"></div>
                    <button class="toolbar-btn" onclick="insertFormatting('h1')" title="Heading 1">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M8.637 13V3.669H7.379V7.62H2.758V3.67H1.5V13h1.258V8.728h4.62V13h1.259zm5.329 0V3.669h-1.244L10.5 5.316v1.265l2.16-1.565h.062V13h1.244z"/></svg>
                    </button>
                    <button class="toolbar-btn" onclick="insertFormatting('h2')" title="Heading 2">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M7.638 13V3.669H6.38V7.62H1.759V3.67H.5V13h1.258V8.728h4.62V13h1.259zm3.022-6.733v-.048c0-.889.63-1.668 1.716-1.668.957 0 1.675.608 1.675 1.572 0 .855-.554 1.504-1.067 2.085l-3.513 3.999V13H15.5v-1.094h-4.245v-.075l2.481-2.844c.875-.998 1.586-1.784 1.586-2.953 0-1.463-1.155-2.556-2.919-2.556-1.941 0-2.966 1.326-2.966 2.74v.049h1.223z"/></svg>
                    </button>
                    <button class="toolbar-btn" onclick="insertFormatting('h3')" title="Heading 3">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M7.637 13V3.669H6.379V7.62H1.758V3.67H.5V13h1.258V8.728h4.62V13h1.259zm3.625-4.272h1.018c1.142 0 1.935.67 1.935 1.704 0 1.17-.787 1.704-1.935 1.704-1.206 0-1.887-.636-1.887-1.704h-1.23c0 1.48 1.07 2.733 3.117 2.733 1.975 0 3.176-1.16 3.176-2.733 0-1.047-.61-1.877-1.693-2.148v-.059c.922-.256 1.458-1.027 1.458-1.98 0-1.421-1.07-2.568-2.88-2.568-1.934 0-2.933 1.239-2.933 2.568h1.23c0-.84.587-1.537 1.703-1.537.957 0 1.65.607 1.65 1.537 0 .977-.693 1.653-1.85 1.653h-.9v1.03z"/></svg>
                    </button>
                    <div class="toolbar-separator"></div>
                    <button class="toolbar-btn" onclick="insertFormatting('link')" title="Insert Link (Ctrl+K)">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M6.354 5.5H4a3 3 0 0 0 0 6h3a3 3 0 0 0 2.83-4H9c-.086 0-.17.01-.25.031A2 2 0 0 1 7 10.5H4a2 2 0 1 1 0-4h1.535c.218-.376.495-.714.82-1z"/><path d="M9 5.5a3 3 0 0 0-2.83 4h1.098A2 2 0 0 1 9 6.5h3a2 2 0 1 1 0 4h-1.535a4.02 4.02 0 0 1-.82 1H12a3 3 0 1 0 0-6H9z"/></svg>
                    </button>
                    <button class="toolbar-btn" onclick="insertFormatting('wikilink')" title="Insert Wiki Link [[]]">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M2 1a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H2zm6.5 4.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3a.5.5 0 0 1 1 0z"/></svg>
                    </button>
                    <button class="toolbar-btn" onclick="insertFormatting('code')" title="Inline Code">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M5.854 4.854a.5.5 0 1 0-.708-.708l-3.5 3.5a.5.5 0 0 0 0 .708l3.5 3.5a.5.5 0 0 0 .708-.708L2.707 8l3.147-3.146zm4.292 0a.5.5 0 0 1 .708-.708l3.5 3.5a.5.5 0 0 1 0 .708l-3.5 3.5a.5.5 0 0 1-.708-.708L13.293 8l-3.147-3.146z"/></svg>
                    </button>
                    <button class="toolbar-btn" onclick="insertFormatting('codeblock')" title="Code Block">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M10.478 1.647a.5.5 0 1 0-.956-.294l-4 13a.5.5 0 0 0 .956.294l4-13zM4.854 4.146a.5.5 0 0 1 0 .708L1.707 8l3.147 3.146a.5.5 0 0 1-.708.708l-3.5-3.5a.5.5 0 0 1 0-.708l3.5-3.5a.5.5 0 0 1 .708 0zm6.292 0a.5.5 0 0 0 0 .708L14.293 8l-3.147 3.146a.5.5 0 0 0 .708.708l3.5-3.5a.5.5 0 0 0 0-.708l-3.5-3.5a.5.5 0 0 0-.708 0z"/></svg>
                    </button>
                    <div class="toolbar-separator"></div>
                    <button class="toolbar-btn" onclick="insertFormatting('quote')" title="Blockquote">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M12 12a1 1 0 0 0 1-1V8.558a1 1 0 0 0-1-1h-1.388c0-.351.021-.703.062-1.054.062-.372.166-.703.31-.992.145-.29.331-.517.559-.683.227-.186.516-.279.868-.279V3c-.579 0-1.085.124-1.52.372a3.322 3.322 0 0 0-1.085.992 4.92 4.92 0 0 0-.62 1.458A7.712 7.712 0 0 0 9 7.558V11a1 1 0 0 0 1 1h2zm-6 0a1 1 0 0 0 1-1V8.558a1 1 0 0 0-1-1H4.612c0-.351.021-.703.062-1.054.062-.372.166-.703.31-.992.145-.29.331-.517.559-.683.227-.186.516-.279.868-.279V3c-.579 0-1.085.124-1.52.372a3.322 3.322 0 0 0-1.085.992 4.92 4.92 0 0 0-.62 1.458A7.712 7.712 0 0 0 3 7.558V11a1 1 0 0 0 1 1h2z"/></svg>
                    </button>
                    <button class="toolbar-btn" onclick="insertFormatting('ul')" title="Bullet List">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path fill-rule="evenodd" d="M5 11.5a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5zm-3 1a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm0 4a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm0 4a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/></svg>
                    </button>
                    <button class="toolbar-btn" onclick="insertFormatting('ol')" title="Numbered List">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path fill-rule="evenodd" d="M5 11.5a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5z"/><path d="M1.713 11.865v-.474H2c.217 0 .363-.137.363-.317 0-.185-.158-.31-.361-.31-.223 0-.367.152-.373.31h-.59c.016-.467.373-.787.986-.787.588-.002.954.291.957.703a.595.595 0 0 1-.492.594v.033a.615.615 0 0 1 .569.631c.003.533-.502.8-1.051.8-.656 0-1-.37-1.008-.794h.582c.008.178.186.306.422.309.254 0 .424-.145.422-.35-.002-.195-.155-.348-.414-.348h-.3zm-.004-4.699h-.604v-.035c0-.408.295-.844.958-.844.583 0 .96.326.96.756 0 .389-.257.617-.476.848l-.537.572v.03h1.054V9H1.143v-.395l.957-.99c.138-.142.293-.304.293-.508 0-.18-.147-.32-.342-.32a.33.33 0 0 0-.342.338v.041zM2.564 5h-.635V2.924h-.031l-.598.42v-.567l.629-.443h.635V5z"/></svg>
                    </button>
                    <button class="toolbar-btn" onclick="insertFormatting('task')" title="Task List">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M14 1a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h12zM2 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H2z"/><path d="M10.97 4.97a.75.75 0 0 1 1.071 1.05l-3.992 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093 3.473-4.425a.235.235 0 0 1 .02-.022z"/></svg>
                    </button>
                    <div class="toolbar-separator"></div>
                    <button class="toolbar-btn" onclick="insertFormatting('hr')" title="Horizontal Rule">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M12 3H4a1 1 0 0 0-1 1v2.5H2V4a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v2.5h-1V4a1 1 0 0 0-1-1zM2 9.5h12V12a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V9.5zm13 0V12a3 3 0 0 1-3 3H4a3 3 0 0 1-3-3V9.5h14zM1.5 7.5a.5.5 0 0 0 0 1h13a.5.5 0 0 0 0-1h-13z"/></svg>
                    </button>
                    <button class="toolbar-btn" onclick="insertFormatting('table')" title="Insert Table">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M0 2a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V2zm15 2h-4v3h4V4zm0 4h-4v3h4V8zm0 4h-4v3h3a1 1 0 0 0 1-1v-2zm-5 3v-3H6v3h4zm-5 0v-3H1v2a1 1 0 0 0 1 1h3zm-4-4h4V8H1v3zm0-4h4V4H1v3zm5-3v3h4V4H6zm4 4H6v3h4V8z"/></svg>
                    </button>
                    <div class="toolbar-separator"></div>
                    <button class="toolbar-btn view-mode-btn" onclick="switchEditorTab('edit')" title="Edit Mode" data-mode="edit">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M12.854.146a.5.5 0 0 0-.707 0L10.5 1.793 14.207 5.5l1.647-1.646a.5.5 0 0 0 0-.708l-3-3zm.646 6.061L9.793 2.5 3.293 9H3.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.207l6.5-6.5zm-7.468 7.468A.5.5 0 0 1 6 13.5V13h-.5a.5.5 0 0 1-.5-.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.5-.5V10h-.5a.499.499 0 0 1-.175-.032l-.179.178a.5.5 0 0 0-.11.168l-2 5a.5.5 0 0 0 .65.65l5-2a.5.5 0 0 0 .168-.11l.178-.178z"/></svg>
                    </button>
                    <button class="toolbar-btn view-mode-btn" onclick="switchEditorTab('preview')" title="Preview Mode" data-mode="preview">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8zM1.173 8a13.133 13.133 0 0 1 1.66-2.043C4.12 4.668 5.88 3.5 8 3.5c2.12 0 3.879 1.168 5.168 2.457A13.133 13.133 0 0 1 14.828 8c-.058.087-.122.183-.195.288-.335.48-.83 1.12-1.465 1.755C11.879 11.332 10.119 12.5 8 12.5c-2.12 0-3.879-1.168-5.168-2.457A13.134 13.134 0 0 1 1.172 8z"/><path d="M8 5.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5zM4.5 8a3.5 3.5 0 1 1 7 0 3.5 3.5 0 0 1-7 0z"/></svg>
                    </button>
                    <button class="toolbar-btn view-mode-btn" onclick="switchEditorTab('split')" title="Split Mode" data-mode="split">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M1.5 1a.5.5 0 0 0-.5.5v13a.5.5 0 0 0 .5.5h13a.5.5 0 0 0 .5-.5v-13a.5.5 0 0 0-.5-.5h-13zm1 1h5.5v12H2.5V2zm6.5 0h5v12H9V2z"/></svg>
                    </button>
                </div>

                <!-- Panes Wrapper -->
                <div class="panes-wrapper" id="panesWrapper">
                    <!-- Edit Mode -->
                    <div class="editor-pane" id="editPane">
                        <div id="markdownEditor"></div>
                    </div>

                    <!-- Preview Mode -->
                    <div class="preview-pane" id="previewPane" style="display:none;">
                        <div id="markdownPreview" class="markdown-preview"></div>
                    </div>
                </div>
            </div>

            <!-- Empty State -->
            <div class="empty-state" id="emptyState">
                <div class="empty-icon">üå≥</div>
                <h2>Welcome to Storyroot</h2>
                <p>Create a new note to get started, or select one from the sidebar.</p>
                <button class="primary-btn" onclick="createNewNote()">Create Your First Note</button>
            </div>
        </main>

        <!-- Right Sidebar - Backlinks & Metadata -->
        <aside class="sidebar right-sidebar" id="rightSidebar">
            <div class="sidebar-header">
                <h3>Note Info</h3>
                <button class="icon-btn" onclick="toggleRightSidebar()">‚ñ∂</button>
            </div>

            <!-- Scrollable Content Container -->
            <div class="sidebar-content">
                <!-- Table of Contents -->
                <div class="toc-section" id="tocSection">
                    <h4>Table of Contents</h4>
                    <div id="tableOfContents" class="toc-container">
                        <span class="empty-message">No headers</span>
                    </div>
                </div>

                <!-- Note Metadata -->
                <div class="metadata-section">
                    <h4>Metadata</h4>
                    <div id="noteMetadata">
                        <div class="meta-item">
                            <span class="meta-label">Created:</span>
                            <span class="meta-value" id="createdDate">-</span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label">Modified:</span>
                            <span class="meta-value" id="modifiedDate">-</span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label">Words:</span>
                            <span class="meta-value" id="wordCount">0</span>
                        </div>
                    </div>
                </div>

                <!-- Tags -->
                <div class="tags-section">
                    <h4>Tags</h4>
                    <div id="noteTags" class="tags-container">
                        <span class="empty-message">No tags</span>
                    </div>
                </div>

                <!-- Outgoing Links -->
                <div class="links-section">
                    <h4>Links in this note</h4>
                    <div id="outgoingLinks" class="links-container">
                        <span class="empty-message">No links</span>
                    </div>
                </div>

                <!-- Backlinks -->
                <div class="backlinks-section">
                    <h4>Backlinks</h4>
                    <div id="backlinks" class="links-container">
                        <span class="empty-message">No backlinks</span>
                    </div>
                </div>
            </div>
        </aside>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>‚öôÔ∏è Settings</h3>
                <button class="close-btn" onclick="closeSettingsModal()">‚úï</button>
            </div>

            <div class="settings-section">
                <h4>Appearance</h4>
                <label>
                    Theme:
                    <select id="themeSelect" onchange="changeTheme()">
                        <option value="light">Light</option>
                        <option value="dark">Dark</option>
                        <option value="obsidian">Obsidian</option>
                        <option value="sepia">Sepia</option>
                    </select>
                </label>
                <label>
                    Editor Font:
                    <select id="fontFamilySelect" onchange="changeFontFamily()">
                        <option value="monospace">Monospace (Default)</option>
                        <option value="sans-serif">Sans Serif</option>
                        <option value="serif">Serif</option>
                        <option value="courier">Courier New</option>
                        <option value="consolas">Consolas</option>
                        <option value="monaco">Monaco</option>
                        <option value="georgia">Georgia</option>
                        <option value="times">Times New Roman</option>
                        <option value="arial">Arial</option>
                        <option value="verdana">Verdana</option>
                        <option value="comic">Comic Sans MS</option>
                    </select>
                </label>
                <label>
                    Font Size:
                    <input type="range" id="fontSizeRange" min="12" max="24" value="16" oninput="changeFontSize()">
                    <span id="fontSizeValue">16px</span>
                </label>
            </div>

            <div class="settings-section">
                <h4>Editor</h4>
                <label class="checkbox-label">
                    <input type="checkbox" id="autoSaveCheckbox" checked onchange="toggleAutoSave()">
                    <span>Auto-save</span>
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" id="vimModeCheckbox" onchange="toggleVimMode()">
                    <span>Vim mode</span>
                </label>
            </div>

            <div class="settings-section">
                <h4>Data Management</h4>
                <button class="secondary-btn" onclick="exportVault()">üíæ Export All Notes</button>
                <label class="file-input-label">
                    <input type="file" id="importFile" accept=".json" onchange="importVault(this.files[0])" style="display:none;">
                    Import Vault
                </label>
                <button class="danger-btn" onclick="clearAllData()">üóëÔ∏è Clear All Data</button>
            </div>

            <div class="modal-buttons">
                <button onclick="closeSettingsModal()" class="primary-btn">Close</button>
            </div>
        </div>
    </div>

    <!-- Rename Modal -->
    <div id="renameModal" class="modal">
        <div class="modal-content small">
            <div class="modal-header">
                <h3>Rename</h3>
                <button class="close-btn" onclick="closeRenameModal()">‚úï</button>
            </div>
            <input type="text" id="renameInput" placeholder="New name">
            <div class="modal-buttons">
                <button onclick="confirmRename()" class="primary-btn" id="renameConfirmBtn">Rename</button>
                <button onclick="closeRenameModal()" class="secondary-btn">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="modal">
        <div class="modal-content small">
            <div class="modal-header">
                <h3>‚ö†Ô∏è Confirm Delete</h3>
                <button class="close-btn" onclick="closeDeleteModal()">‚úï</button>
            </div>
            <p id="deleteMessage">Are you sure you want to delete this item?</p>
            <div class="modal-buttons">
                <button onclick="confirmDelete()" class="danger-btn">Delete</button>
                <button onclick="closeDeleteModal()" class="secondary-btn">Cancel</button>
            </div>
        </div>
    </div>

    <script src="Storyroot.js"></script>
</body>
</html>
